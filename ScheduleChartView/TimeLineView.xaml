<UserControl
    x:Class="ScheduleChartView.TimeLineView" xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"  xmlns:local="clr-namespace:ScheduleChartView"
    xmlns:convert="clr-namespace:ScheduleChartView.Convert"
    mc:Ignorable="d"  d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Resources>
        <convert:TimeWindowLeftConverter x:Key="TimeWindowLeft" />
        <convert:DurationToWidthConverter x:Key="DurToWidth" />
        <convert:RowToTopConverter x:Key="RowToTop" />

        <DataTemplate x:Key="SegmentTemplate" DataType="{x:Type local:SegmentVM}">
            <Border CornerRadius="6"
                    Background="{Binding Brush}"
                    Height="{Binding DataContext.SegmentHeight, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                    ToolTip="{Binding Tooltip}" />
        </DataTemplate>
    </UserControl.Resources>
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="28" />
        </Grid.RowDefinitions>

        <!-- 컨트롤 패널 -->
        <StackPanel Grid.Row="0" Orientation="Horizontal">
            <TextBlock Text="Update every" VerticalAlignment="Center" />
            <Slider Width="160" Minimum="1" Maximum="10"
                    Value="{Binding UpdateIntervalSeconds, Mode=TwoWay}" TickFrequency="1" IsSnapToTickEnabled="True" />
            <TextBlock Text="{Binding UpdateIntervalSeconds, StringFormat={}{0}s}" Width="40" VerticalAlignment="Center" />
            <Separator Width="12" />
            <TextBlock Text="Scale" VerticalAlignment="Center" />
            <Slider Width="160" Minimum="5" Maximum="40"
                    Value="{Binding PixelsPerSecond, Mode=TwoWay}" TickFrequency="5" IsSnapToTickEnabled="True" />
            <TextBlock Text="{Binding PixelsPerSecond, StringFormat={}{0} px/s}" VerticalAlignment="Center" Margin="6,0,0,0" />
            <TextBlock Text="{Binding NowLocal, StringFormat=  •  Now: {0:HH:mm:ss}}" VerticalAlignment="Center" Margin="12,0,0,0" />
        </StackPanel>

        <!-- 타임라인 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="48" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Y축 라벨 -->
            <ItemsControl Grid.Column="0" ItemsSource="{Binding Rows}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <Canvas />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemContainerStyle>
                    <Style TargetType="ContentPresenter">
                        <Setter Property="Canvas.Top">
                            <Setter.Value>
                                <MultiBinding Converter="{StaticResource RowToTop}">
                                    <Binding />
                                    <Binding Path="DataContext.RowHeight" RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                                </MultiBinding>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ItemsControl.ItemContainerStyle>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <TextBlock Text="{Binding}" FontSize="16" Height="{Binding DataContext.RowHeight, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                                   VerticalAlignment="Center" HorizontalAlignment="Right" Margin="0,0,6,0" />
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- 최근 60초 캔버스 -->
            <ScrollViewer Grid.Column="1" HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Hidden">
                <ItemsControl ItemsSource="{Binding VisibleSegments}" ItemTemplate="{StaticResource SegmentTemplate}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas Width="{Binding CanvasWidth}" Height="{Binding CanvasHeight}" Background="#FFFDFDFD" ClipToBounds="True" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <!-- X 위치: StartTime이 윈도우 내에서 몇 초인지 계산 -->
                            <Setter Property="Canvas.Left">
                                <Setter.Value>
                                    <MultiBinding Converter="{StaticResource TimeWindowLeft}">
                                        <Binding Path="StartTime" />
                                        <Binding Path="DataContext.NowUtc" RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                                        <Binding Path="DataContext.WindowSeconds" RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                                        <Binding Path="DataContext.PixelsPerSecond" RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                                    </MultiBinding>
                                </Setter.Value>
                            </Setter>
                            <!-- Y 위치 -->
                            <Setter Property="Canvas.Top">
                                <Setter.Value>
                                    <MultiBinding Converter="{StaticResource RowToTop}">
                                        <Binding Path="Row" />
                                        <Binding Path="DataContext.RowHeight" RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                                    </MultiBinding>
                                </Setter.Value>
                            </Setter>
                            <!-- 너비 -->
                            <Setter Property="Width">
                                <Setter.Value>
                                    <MultiBinding Converter="{StaticResource DurToWidth}">
                                        <Binding Path="Duration" />
                                        <Binding Path="DataContext.PixelsPerSecond" RelativeSource="{RelativeSource AncestorType=ItemsControl}" />
                                    </MultiBinding>
                                </Setter.Value>
                            </Setter>
                            <Setter Property="Height" Value="{Binding DataContext.SegmentHeight, RelativeSource={RelativeSource AncestorType=ItemsControl}}" />
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                </ItemsControl>
            </ScrollViewer>
        </Grid>

        <!-- X축 라벨 -->
        <DockPanel Grid.Row="2">
            <TextBlock Text="← 60s window →  ms/seconds scaled" Margin="6,0,0,0" />
            <TextBlock Text="{Binding CanvasWidth, StringFormat=Width: {0:0}px}" Margin="12,0,0,0" />
        </DockPanel>
    </Grid>
</UserControl>